@{
    Layout = "~/Views/Shared/_MainLayout.cshtml";
}

@section Headers {
    <link rel="stylesheet" href="../assets/MaterialDesign-Webfont/css/materialdesignicons.min.css" media="all" />
    <link rel="stylesheet" href="../assets/css/custom.css">

    <!-- flatpick plugin -->
    <link rel="stylesheet" href="../assets/flatpickr/flatpickr.min.css">
    <script src="../assets/flatpickr/flatpickr.js"></script>
    <script src="../assets/flatpickr/zh-tw.js"></script>
}

<!-- 開狀沖正(EC) -->
<div id="lcListPage" class="py-4 px-5">
    <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
        <ol class="breadcrumb fs-6">
            <li class="breadcrumb-item">
                <a id="homePage" class="hnb__path" href="#" onclick="backHomeHandler()">首頁</a>
            </li>
            <li class="breadcrumb-item">申請作業</li>
            <li class="breadcrumb-item">當日沖正交易</li>
            <li class="breadcrumb-item active" aria-current="page">開狀沖正(EC)</li>
        </ol>
    </nav>

    <!-- 開狀沖正(EC)清冊 -->
    <div id="queryList">
        @{
            await Html.RenderPartialAsync("~/Views/AmendLcApp/QueryList.cshtml");
        }
    </div>

    <!-- 開狀申請書 (由後端產生並透過 AJAX 取得) -->
    <div id="lcAppList" class="hnb__hide">
    </div>
</div>

<!-- 授信資料預覽 視窗 -->
@await Html.PartialAsync("~/Views/AmendLcApp/CreditModal.cshtml")

@section Scripts {
    <script>
        const queryList = document.querySelector('#queryList');
        const lcForCdsAppList = document.querySelector('#lcForCdsAppList');
        const lcAppList = document.querySelector('#lcAppList');
        const lcforOtherAppList = document.querySelector('#lcforOtherAppList');

        // 確認 訊息及按鈕
        // note: message modal will be returned from server as partial and injected into DOM

        // 不同權限切換顯示欄位
        if (authType === 'BH') {
          const notConfirmBtn = document.querySelector('#notConfirmBtn');
          if (notConfirmBtn) notConfirmBtn.classList.add('hnb__hide');
        };

        // 查詢押匯申請 searchHandler
        function searchHandler() {
          queryList.classList.remove('hnb__hide');
        };

        // 檢視開狀申請書 - 從後端載入內容
        function reviewLcApp() {
          try {
                var postData = {
                lcNo: currentDataRow.lcno
                    };

            $('#lcAppList').remove();
            doPost('../AmendLcApp/LcAppList',postData,function(data){
                queryList.classList.add('hnb__hide');
                $(queryList).after(data);
            });
          } catch (err) {
            console.error(err);
          }
        }

        // 呼叫後端顯示確認沖正視窗 (使用 doPost JSON)
        function confirmReview() {
          try {
            var postData = {
              lcNo: currentDataRow ? currentDataRow.lcno : '',
              authType: authType || '',
              revertStatus: false
            };

            doPost('../AmendLcApp/ConfirmReview', postData, function (html) {
                $('body').append(html);
            });
          } catch (err) {
            console.error(err);
          }
        }

        function confirmHandler() {
            try {
                const form = document.querySelector('#confirmReviewForm');
                if (!form) return;

                var lcNoInput = form.querySelector('input[name="lcNo"]');
                var revertInput = form.querySelector('input[name="revertStatus"]');

                var postData = {
                    lcNo: lcNoInput ? lcNoInput.value : '',
                    revertStatus: revertInput ? (revertInput.value === 'True' || revertInput.value === 'true' || revertInput.value === '1') : false
                };

                doPost('../AmendLcApp/ConfirmHandler', postData, function (html) {
                    if (window.hideCurrent) window.hideCurrent();
                    $('body').append(html);
                });
            } catch (err) {
                console.error(err);
            }
        }

        // 不沖正 notConfirmReview -> call server with revertStatus true (使用 doPost JSON)
        function notConfirmReview() {
          try {
            var postData = {
              lcNo: currentDataRow ? currentDataRow.lcno : '',
              authType: authType || '',
              revertStatus: true
            };

            doPost('../AmendLcApp/ConfirmReview', postData, function (html) {
              const container = document.createElement('div');
              container.innerHTML = html;
              document.body.appendChild(container);
            });
          } catch (err) {
            console.error(err);
          }
        };

        // 取消
        function cancelHandler() {
          queryList.classList.remove('hnb__hide');
          $('#lcAppList').remove();
        };

        // 月曆
        const dateAlert = document.querySelector(".dateAlert");
        const currentTime = new Date()
        const config = {
          locale: 'zh_tw',
          //enableTime: true, //可選時與分
          dateFormat: "Y/m/d", //時間格式
          time_24hr: true, //24 時制
          minuteIncrement: 15, //分鐘每次選擇間隔單位
          allowInput: true, //可輸入控制
          //minDate: "today", //可選最小時間，可直接接受 'today' 字串
          //maxDate: currentTime.setMonth(currentTime.getMonth() + 1), //可選最大時間，從今天起一個月
          onChange: function (selectedDates, dateStr, instance) {
            console.log(`你現在點選的是 ${instance.input.id}，時間為 ${selectedDates} / ${dateStr}`);
            checkDateTime(dateStr, instance.input.id);
          }
        };
        flatpickr('#startDate, #endDate', config);

        let startDateValue = null
        let endDateValue = null

        // 辨別結束日期須晚於開始日期
        function checkDateTime(dateStr, id) {
          if (id === "startDate") {
            startDateValue = dateStr
          }

          if (id === "endDate") {
            endDateValue = dateStr
          }

          if (startDateValue > endDateValue) {
            dateAlert.classList.remove("d-none");
          } else {
            dateAlert.classList.add("d-none");
          }
        };

        // 匯票到期日 / 匯票發票日 - 日期選擇器
        flatpickr('#draftDate, #invoiceDate', config);

    </script>
    @{
        await Html.RenderPartialAsync("~/Views/MainPage/Module/PrepareQuery.cshtml");
    }
}